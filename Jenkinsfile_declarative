pipeline {

    agent { label 'built-in' }

    environment {
        VERSION            = '1.2.0'
        DOCKER_IMAGE       = 'zip-job-test'
        ARTIFACTORY_SERVER = 'artifactory-tlv'
        ARTIFACTORY_REPO   = 'binary-storage'
    }

    options {
        skipDefaultCheckout(true)
    }

    stages {

        stage('Checkout') {
            steps {
                checkout scm
                echo "Checked out repository into workspace."
            }
        }

        stage('Build Docker Image') {
            steps {
                echo "Building Docker image: ${env.DOCKER_IMAGE}"
                bat """
                    cd "%WORKSPACE%"
                    docker build -t ${DOCKER_IMAGE} .
                """
            }
        }

        stage('Run zip_job.py') {
            steps {
                echo "Running zip_job.py inside Docker container..."
                bat """
                    docker run --rm ^
                        -e VERSION=${VERSION} ^
                        -v "%WORKSPACE%":/app ^
                        -w /app ^
                        ${DOCKER_IMAGE} python3 /tmp/zip_job.py
                """
                bat "dir *.zip"
            }
        }

        stage('Publish Artifacts to Artifactory') {
            steps {
                echo "Uploading artifacts to Artifactory..."
                script {
                    def server    = Artifactory.server(ARTIFACTORY_SERVER)
                    def buildInfo = Artifactory.newBuildInfo()

                    server.upload(
                        spec: """{
                            "files": [
                                {
                                    "pattern": "*.zip",
                                    "target": "${ARTIFACTORY_REPO}/${VERSION}/"
                                }
                            ]
                        }""",
                        buildInfo: buildInfo
                    )

                    server.publishBuildInfo(buildInfo)
                }
            }
        }

        stage('Cleanup Workspace') {
            steps {
                cleanWs()
            }
        }

        stage('Report') {
            steps {
                script {
                    def status = currentBuild.currentResult
                    mail(
                        to: 'amirmalka26@gmail.com',
                        subject: "Job ${env.JOB_NAME} #${env.BUILD_NUMBER} - ${status}",
                        body: """Pipeline result: ${status}
Console: ${env.BUILD_URL}console"""
                    )
                }
            }
        }
    }
}
